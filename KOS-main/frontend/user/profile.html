<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya - Kos Atma</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-brand">Kos Atma</a>
            
            <button class="nav-toggle" id="navToggle">â˜°</button>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="../index.html">Beranda</a></li>
                <li><a href="../pages/cari-kos.html">Cari Kos</a></li>
                
                <!-- Guest Menu (hidden when logged in) -->
                <li class="guest-menu">
                    <a href="../auth/login.html" class="btn btn-outline">Masuk</a>
                </li>
                <li class="guest-menu">
                    <a href="../auth/register.html" class="btn btn-primary">Daftar</a>
                </li>
                
                <!-- User Menu (hidden when not logged in) -->
                <li class="user-menu" style="display: none;">
                    <div class="nav-dropdown">
                        <a href="#" class="dropdown-toggle">
                            <img src="../assets/images/default-avatar.svg" alt="Profile" class="nav-profile-img" id="navProfileImg">
                            <span id="navUserName">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="profile.html" class="active">Profil Saya</a></li>
                            <li><a href="my-bookings.html">Booking Saya</a></li>
                            <li><a href="chat.html" class="inbox-link">Inbox <span id="inboxBadge" class="inbox-badge" style="display: none;">0</span></a></li>
                            <li class="admin-link" style="display: none;"><a href="../admin/dashboard.html">Admin Panel</a></li>
                            <li><hr></li>
                            <li><a href="#" id="logoutBtn">Keluar</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>Profil Saya</h1>
                <p>Kelola informasi profil Anda</p>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <div class="profile-grid">
                <!-- Photo Section -->
                <div class="card profile-photo-card">
                    <div class="card-header">
                        <h3>Foto Profil</h3>
                    </div>
                    <div class="card-body text-center">
                        <div class="profile-photo-container">
                            <img id="profilePhoto" src="../assets/images/default-avatar.svg" alt="Foto Profil">
                        </div>
                        <form id="photoForm" enctype="multipart/form-data">
                            <input type="file" id="photoInput" name="foto" accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
                                Pilih Foto
                            </button>
                            <button type="submit" class="btn btn-primary" id="uploadBtn" style="display: none;">
                                Upload
                            </button>
                        </form>
                        <small class="text-muted">Format: JPG, PNG. Maksimal 2MB</small>
                    </div>
                </div>

                <!-- Profile Info Section -->
                <div class="card profile-info-card">
                    <div class="card-header">
                        <h3>Informasi Profil</h3>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="form-group">
                                <label for="nama">Nama Lengkap</label>
                                <input type="text" id="nama" name="nama" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input type="text" id="username" name="username" readonly class="readonly">
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" readonly class="readonly">
                            </div>
                            
                            <div class="form-group">
                                <label for="telepon">No. Telepon</label>
                                <input type="tel" id="telepon" name="telepon" placeholder="Masukkan no. telepon">
                            </div>
                            
                            <div class="form-group">
                                <label for="alamat">Alamat</label>
                                <textarea id="alamat" name="alamat" rows="3" placeholder="Masukkan alamat"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                                Simpan Perubahan
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="card password-card">
                    <div class="card-header">
                        <h3>Ubah Password</h3>
                    </div>
                    <div class="card-body">
                        <form id="passwordForm">
                            <div class="form-group">
                                <label for="currentPassword">Password Saat Ini</label>
                                <input type="password" id="currentPassword" name="current_password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="newPassword">Password Baru</label>
                                <input type="password" id="newPassword" name="new_password" required minlength="6">
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword">Konfirmasi Password Baru</label>
                                <input type="password" id="confirmPassword" name="confirm_password" required>
                            </div>
                            
                            <button type="submit" class="btn btn-warning" id="changePasswordBtn">
                                Ubah Password
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; 2025 Kos Atma. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Cek autentikasi
            currentUser = await requireAuth();
            if (!currentUser) return;

            // Update navbar - hide guest, show user
            document.querySelectorAll('.guest-menu').forEach(el => {
                el.classList.remove('show');
                el.style.display = 'none';
            });
            document.querySelectorAll('.user-menu').forEach(el => {
                el.classList.add('show');
                el.style.display = 'block';
            });
            
            // Nama depan saja
            const firstName = currentUser.nama.split(' ')[0];
            document.getElementById('navUserName').textContent = firstName;
            const navProfileImg = document.getElementById('navProfileImg');
            if (currentUser.foto) {
                navProfileImg.src = UPLOAD_BASE_URL + '/profiles/' + currentUser.foto;
            }
            navProfileImg.onerror = function() {
                this.src = '../assets/images/default-avatar.svg';
            };
            
            // Show admin link if admin
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-link').forEach(el => {
                    el.classList.add('show');
                    el.style.display = 'block';
                });
            }
            
            // Logout handler
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
            
            // Mobile nav toggle
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }

            // Load profil
            loadProfile();

            // Handle photo preview
            document.getElementById('photoInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profilePhoto').src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                    document.getElementById('uploadBtn').style.display = 'inline-block';
                }
            });

            // Handle photo upload
            document.getElementById('photoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('photoInput');
                if (!fileInput.files[0]) return;

                const uploadBtn = document.getElementById('uploadBtn');
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Mengupload...';

                try {
                    const formData = new FormData();
                    formData.append('foto', fileInput.files[0]);

                    const response = await API.user.uploadPhoto(formData);

                    if (response.success) {
                        showAlert('success', 'Foto berhasil diupload!');
                        uploadBtn.style.display = 'none';
                        // Update foto di navbar jika ada
                    } else {
                        showAlert('danger', response.message);
                    }
                } catch (error) {
                    showAlert('danger', 'Gagal mengupload foto');
                }

                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
            });

            // Handle profile update
            document.getElementById('profileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('saveProfileBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';

                const formData = {
                    nama: document.getElementById('nama').value,
                    telepon: document.getElementById('telepon').value,
                    alamat: document.getElementById('alamat').value
                };

                try {
                    const response = await API.user.update(formData);
                    console.log('Update response:', response);

                    if (response.success) {
                        showAlert('success', 'Profil berhasil diperbarui!');
                        // Update localStorage
                        const user = JSON.parse(localStorage.getItem('user'));
                        if (user) {
                            user.nama = formData.nama;
                            localStorage.setItem('user', JSON.stringify(user));
                        }
                        // Update navbar name
                        const navUserName = document.getElementById('navUserName');
                        if (navUserName) {
                            navUserName.textContent = formData.nama.split(' ')[0];
                        }
                    } else {
                        showAlert('danger', response.message || 'Gagal memperbarui profil');
                    }
                } catch (error) {
                    console.error('Update error:', error);
                    showAlert('danger', 'Gagal memperbarui profil: ' + error.message);
                }

                saveBtn.disabled = false;
                saveBtn.textContent = 'Simpan Perubahan';
            });

            // Handle password change
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    showAlert('danger', 'Password baru tidak cocok!');
                    return;
                }

                const changeBtn = document.getElementById('changePasswordBtn');
                changeBtn.disabled = true;
                changeBtn.textContent = 'Memproses...';

                const formData = {
                    current_password: document.getElementById('currentPassword').value,
                    new_password: newPassword,
                    confirm_password: confirmPassword
                };

                try {
                    const response = await API.user.changePassword(formData);

                    if (response.success) {
                        showAlert('success', 'Password berhasil diubah!');
                        document.getElementById('passwordForm').reset();
                    } else {
                        showAlert('danger', response.message);
                    }
                } catch (error) {
                    showAlert('danger', 'Gagal mengubah password');
                }

                changeBtn.disabled = false;
                changeBtn.textContent = 'Ubah Password';
            });
        });

        async function loadProfile() {
            try {
                const response = await API.user.getProfile();

                if (response.success) {
                    const user = response.data.user || response.data;
                    document.getElementById('nama').value = user.nama || '';
                    document.getElementById('username').value = user.username || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('telepon').value = user.telepon || '';
                    document.getElementById('alamat').value = user.alamat || '';
                    
                    if (user.foto) {
                        document.getElementById('profilePhoto').src = UPLOAD_BASE_URL + '/profiles/' + user.foto;
                    }
                } else {
                    showAlert('danger', response.message || 'Gagal memuat profil');
                }
            } catch (error) {
                console.error('Load profile error:', error);
                showAlert('danger', 'Terjadi kesalahan saat memuat profil');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
    <script src="../js/user-inbox.js"></script>
</body>
</html>
