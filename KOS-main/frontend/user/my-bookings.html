<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Saya - Kos Atma</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-brand">Kos Atma</a>
            
            <button class="nav-toggle" id="navToggle">â˜°</button>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="../index.html">Beranda</a></li>
                <li><a href="../pages/cari-kos.html">Cari Kos</a></li>
                
                <!-- Guest Menu (hidden when logged in) -->
                <li class="guest-menu">
                    <a href="../auth/login.html" class="btn btn-outline">Masuk</a>
                </li>
                <li class="guest-menu">
                    <a href="../auth/register.html" class="btn btn-primary">Daftar</a>
                </li>
                
                <!-- User Menu (hidden when not logged in) -->
                <li class="user-menu" style="display: none;">
                    <div class="nav-dropdown">
                        <a href="#" class="dropdown-toggle">
                            <img src="../assets/images/default-avatar.svg" alt="Profile" class="nav-profile-img" id="navProfileImg">
                            <span id="navUserName">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="profile.html">Profil Saya</a></li>
                            <li><a href="my-bookings.html" class="active">Booking Saya</a></li>
                            <li><a href="chat.html" class="inbox-link">Inbox <span id="inboxBadge" class="inbox-badge" style="display: none;">0</span></a></li>
                            <li class="admin-link" style="display: none;"><a href="../admin/dashboard.html">Admin Panel</a></li>
                            <li><hr></li>
                            <li><a href="#" id="logoutBtn">Keluar</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>Booking Saya</h1>
                <p>Riwayat dan status booking Anda</p>
            </div>

            <div id="alertContainer"></div>

            <!-- Booking List -->
            <div class="card">
                <div class="card-body">
                    <div id="bookingList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Memuat data...</p>
                        </div>
                    </div>
                    <div id="emptyState" class="empty-state" style="display: none;">
                        <p>Belum ada booking</p>
                        <p>Silakan cari kos dan lakukan booking terlebih dahulu</p>
                        <a href="../pages/cari-kos.html" class="btn btn-primary">Cari Kos</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; 2025 Kos Atma. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const user = await requireAuth();
            if (!user) return;

            // Update navbar - hide guest, show user
            document.querySelectorAll('.guest-menu').forEach(el => {
                el.classList.remove('show');
                el.style.display = 'none';
            });
            document.querySelectorAll('.user-menu').forEach(el => {
                el.classList.add('show');
                el.style.display = 'block';
            });
            
            // Nama depan saja
            const firstName = user.nama.split(' ')[0];
            document.getElementById('navUserName').textContent = firstName;
            const navProfileImg = document.getElementById('navProfileImg');
            if (user.foto) {
                navProfileImg.src = UPLOAD_BASE_URL + '/profiles/' + user.foto;
            }
            navProfileImg.onerror = function() {
                this.src = '../assets/images/default-avatar.svg';
            };
            
            // Show admin link if admin
            if (user.role === 'admin') {
                document.querySelectorAll('.admin-link').forEach(el => {
                    el.classList.add('show');
                    el.style.display = 'block';
                });
            }
            
            // Logout handler
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
            
            // Mobile nav toggle
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }
            
            loadBookings();
        });

        async function loadBookings() {
            try {
                const response = await fetch(API_BASE_URL + '/api/booking/list.php', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                const container = document.getElementById('bookingList');
                const emptyState = document.getElementById('emptyState');

                if (result.success && result.data && result.data.length > 0) {
                    container.innerHTML = result.data.map(booking => `
                        <div class="booking-card">
                            <div class="booking-header">
                                <h3>${booking.kos_nama}</h3>
                                <span class="badge badge-${booking.status}">${getStatusLabel(booking.status)}</span>
                            </div>
                            <div class="booking-info">
                                <p>Kamar ${booking.kamar_nomor}</p>
                                <p>Tanggal Masuk: ${formatDate(booking.tanggal_masuk)}</p>
                                <p>Durasi: ${booking.durasi} bulan</p>
                                <p>Total: Rp ${formatNumber(booking.total_harga)}</p>
                            </div>
                            ${booking.status === 'pending' ? `
                                <div class="booking-actions">
                                    <button class="btn btn-danger btn-sm" onclick="cancelBooking(${booking.id})">
                                        Batalkan
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                document.getElementById('bookingList').innerHTML = 
                    '<p class="text-center text-muted">Gagal memuat data booking</p>';
            }
        }

        async function cancelBooking(id) {
            if (!confirm('Apakah Anda yakin ingin membatalkan booking ini?')) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/booking/cancel.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Booking berhasil dibatalkan');
                    loadBookings();
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', 'Gagal membatalkan booking');
            }
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Menunggu',
                'approved': 'Disetujui',
                'aktif': 'Aktif',
                'active': 'Aktif',
                'rejected': 'Ditolak',
                'cancelled': 'Dibatalkan',
                'selesai': 'Selesai',
                'completed': 'Selesai'
            };
            return labels[status.toLowerCase()] || status;
        }

        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>

    <style>
        .booking-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
        }
        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .booking-header h3 {
            margin: 0;
            font-size: 1.125rem;
            color: var(--gray-800);
        }
        .booking-info p {
            margin: 0.25rem 0;
            color: var(--gray-500);
            font-size: 14px;
        }
        .booking-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }
        .badge-pending { background: var(--yellow-500); color: white; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; }
        .badge-approved { background: var(--green-500); color: white; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; }
        .badge-aktif, .badge-active { background: var(--primary); color: white; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; }
        .badge-rejected { background: var(--red-500); color: white; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; }
        .badge-cancelled { background: var(--gray-500); color: white; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; }
        .badge-selesai, .badge-completed { background: var(--gray-600); color: white; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; }
    </style>
    <script src="../js/user-inbox.js"></script>
</body>
</html>
