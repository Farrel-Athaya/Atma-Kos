<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabang Kami - Kos Atma</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-brand">Kos Atma</a>
            
            <button class="nav-toggle" id="navToggle">☰</button>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="../index.html">Beranda</a></li>
                <li><a href="cari-kos.html" class="active">Cabang Kami</a></li>
                
                <!-- Menu untuk user yang belum login -->
                <li class="guest-menu">
                    <a href="../auth/login.html" class="btn btn-outline">Masuk</a>
                </li>
                <li class="guest-menu">
                    <a href="../auth/register.html" class="btn btn-primary">Daftar</a>
                </li>
                
                <!-- Menu untuk user yang sudah login -->
                <li class="user-menu" style="display: none;">
                    <div class="nav-dropdown">
                        <a href="#" class="dropdown-toggle">
                            <img src="../assets/images/default-avatar.svg" alt="Profile" class="nav-profile-img" id="navProfileImg">
                            <span id="navUserName">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="../user/profile.html">Profil Saya</a></li>
                            <li><a href="../user/my-bookings.html">Booking Saya</a></li>
                            <li><a href="../user/chat.html" class="inbox-link">Inbox <span id="inboxBadge" class="inbox-badge" style="display: none;">0</span></a></li>
                            <li class="admin-link" style="display: none;"><a href="../admin/dashboard.html">Admin Panel</a></li>
                            <li><hr></li>
                            <li><a href="#" id="logoutBtn">Keluar</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>Cabang Kos Atma</h1>
                <p>Pilih cabang kos yang sesuai dengan lokasi Anda</p>
            </div>

            <!-- Search & Filter Section -->
            <div class="search-filter-section">
                <form id="searchForm" class="search-form">
                    <div class="search-row">
                        <div class="form-group">
                            <input type="text" id="keyword" name="keyword" placeholder="Cari nama kos atau alamat...">
                        </div>
                        <div class="form-group">
                            <select id="tipe" name="tipe">
                                <option value="">Semua Tipe</option>
                                <option value="putra">Kos Putra</option>
                                <option value="putri">Kos Putri</option>
                                <option value="campur">Kos Campur</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="hargaMin" name="harga_min">
                                <option value="">Harga Min</option>
                                <option value="500000">Rp 500.000</option>
                                <option value="1000000">Rp 1.000.000</option>
                                <option value="1500000">Rp 1.500.000</option>
                                <option value="2000000">Rp 2.000.000</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="hargaMax" name="harga_max">
                                <option value="">Harga Max</option>
                                <option value="1000000">Rp 1.000.000</option>
                                <option value="1500000">Rp 1.500.000</option>
                                <option value="2000000">Rp 2.000.000</option>
                                <option value="3000000">Rp 3.000.000</option>
                                <option value="5000000">Rp 5.000.000</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Cari
                        </button>
                    </div>
                </form>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="btn btn-outline active" id="listViewBtn" onclick="setView('list')">
                    Daftar
                </button>
                <button class="btn btn-outline" id="mapViewBtn" onclick="setView('map')">
                    Peta
                </button>
            </div>

            <!-- Results Info -->
            <div class="results-info">
                <span id="resultCount">0 kos ditemukan</span>
            </div>

            <!-- List View -->
            <div id="listView" class="kos-list">
                <div id="kosContainer" class="kos-grid">
                    <!-- Kos cards will be loaded here -->
                </div>
                
                <!-- Loading -->
                <div id="loadingSpinner" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Memuat data...</p>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <p>Tidak ada kos yang ditemukan</p>
                    <p>Coba ubah filter pencarian Anda</p>
                </div>
            </div>

            <!-- Map View -->
            <div id="mapView" class="map-container" style="display: none;">
                <div id="kosMap" style="height: 500px;"></div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="pagination">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; 2025 Kos Atma. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentPage = 1;
        let currentView = 'list';
        let map = null;
        let markers = [];
        let allKos = [];

        document.addEventListener('DOMContentLoaded', async function() {
            // Cek autentikasi dan update navbar
            const user = await checkAuth();
            if (user) {
                // Hide guest menu, show user menu
                document.querySelectorAll('.guest-menu').forEach(el => {
                    el.classList.remove('show');
                    el.style.display = 'none';
                });
                document.querySelectorAll('.user-menu').forEach(el => {
                    el.classList.add('show');
                    el.style.display = 'block';
                });
                
                // Set user info - nama depan saja
                const firstName = user.nama.split(' ')[0];
                document.getElementById('navUserName').textContent = firstName;
                const profileImg = document.getElementById('navProfileImg');
                if (user.foto) {
                    profileImg.src = UPLOAD_BASE_URL + '/profiles/' + user.foto;
                } else {
                    profileImg.src = '../assets/images/default-avatar.svg';
                }
                profileImg.onerror = function() {
                    this.src = '../assets/images/default-avatar.svg';
                };
                
                // Show admin link if admin
                if (user.role === 'admin') {
                    document.querySelectorAll('.admin-link').forEach(el => {
                        el.classList.add('show');
                        el.style.display = 'block';
                    });
                }
            } else {
                // Not logged in - show guest menu
                document.querySelectorAll('.guest-menu').forEach(el => {
                    el.classList.add('show');
                    el.style.display = 'block';
                });
            }
            
            // Logout handler
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    logout();
                });
            }
            
            // Mobile nav toggle
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }

            // Load kos
            loadKos();

            // Handle search form
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentPage = 1;
                loadKos();
            });

            // Get URL params
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('q')) {
                document.getElementById('keyword').value = urlParams.get('q');
            }
            if (urlParams.has('keyword')) {
                document.getElementById('keyword').value = urlParams.get('keyword');
            }
            if (urlParams.has('tipe')) {
                document.getElementById('tipe').value = urlParams.get('tipe');
            }
        });

        async function loadKos() {
            const container = document.getElementById('kosContainer');
            const loading = document.getElementById('loadingSpinner');
            const emptyState = document.getElementById('emptyState');
            
            loading.style.display = 'block';
            container.innerHTML = '';
            emptyState.style.display = 'none';

            const params = {
                q: document.getElementById('keyword').value,
                tipe: document.getElementById('tipe').value,
                harga_min: document.getElementById('hargaMin').value,
                harga_max: document.getElementById('hargaMax').value,
                page: currentPage,
                limit: 12
            };

            try {
                const response = await API.kos.getList(params);
                loading.style.display = 'none';

                // Handle response - data bisa array langsung atau nested
                let kosList = [];
                if (response.success) {
                    kosList = Array.isArray(response.data) ? response.data : (response.data?.kos || []);
                }

                if (kosList.length > 0) {
                    allKos = kosList;
                    document.getElementById('resultCount').textContent = `${kosList.length} kos ditemukan`;
                    
                    kosList.forEach(kos => {
                        container.innerHTML += createKosCard(kos);
                    });

                    // Update map if visible
                    if (currentView === 'map') {
                        updateMap();
                    }
                } else {
                    emptyState.style.display = 'block';
                    document.getElementById('resultCount').textContent = '0 kos ditemukan';
                }
            } catch (error) {
                console.error('Error:', error);
                loading.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = '<p>Terjadi kesalahan saat memuat data</p>';
            }
        }

        function createKosCard(kos) {
            // Handle berbagai kemungkinan nama field dari API
            const foto = kos.foto_utama || kos.foto || null;
            const nama = kos.nama_kos || kos.nama;
            const tipe = kos.tipe_kos || kos.tipe;
            const harga = kos.harga_min || kos.harga_terendah || 0;
            
            const imageUrl = foto ? UPLOAD_BASE_URL + '/kos/' + foto : '../assets/images/no-image.svg';
            const tipeLabel = {
                'putra': 'Kos Putra',
                'putri': 'Kos Putri',
                'campur': 'Kos Campur'
            };

            return `
                <div class="kos-card">
                    <div class="kos-image">
                        <img src="${imageUrl}" alt="${nama}" onerror="this.src='../assets/images/no-image.svg'">
                        <span class="kos-badge badge-${tipe}">${tipeLabel[tipe] || tipe}</span>
                    </div>
                    <div class="kos-info">
                        <h3>${nama}</h3>
                        <p class="kos-address">${kos.alamat}</p>
                        <p class="kos-price">Mulai Rp ${formatNumber(harga)}/bulan</p>
                        <p class="kos-rooms">${kos.kamar_tersedia || 0} kamar tersedia</p>
                        <a href="detail-kos.html?id=${kos.id}" class="btn btn-primary btn-block">Lihat Detail</a>
                    </div>
                </div>
            `;
        }

        function setView(view) {
            currentView = view;
            
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            document.getElementById('mapViewBtn').classList.toggle('active', view === 'map');
            
            document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('mapView').style.display = view === 'map' ? 'block' : 'none';
            
            if (view === 'map') {
                initMap();
                setTimeout(() => {
                    if (map) map.invalidateSize();
                    updateMap();
                }, 100);
            }
        }

        function initMap() {
            if (map) return;
            
            map = L.map('kosMap', {
                scrollWheelZoom: false
            }).setView([-7.7826, 110.3672], 12); // Default: Yogyakarta
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        function updateMap() {
            if (!map) return;
            
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            allKos.forEach(kos => {
                if (kos.latitude && kos.longitude) {
                    const nama = kos.nama_kos || kos.nama;
                    const harga = kos.harga_min || kos.harga_terendah || 0;
                    
                    const marker = L.marker([kos.latitude, kos.longitude])
                        .bindPopup(`
                            <strong>${nama}</strong><br>
                            ${kos.alamat}<br>
                            Rp ${formatNumber(harga)}/bulan<br>
                            <a href="detail-kos.html?id=${kos.id}">Lihat Detail</a>
                        `)
                        .addTo(map);
                    markers.push(marker);
                }
            });

            // Fit bounds if markers exist
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }
    </script>
    <script src="../js/user-inbox.js"></script>
</body>
</html>
