<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inbox - Kos Atma</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar" id="navbar">
      <div class="nav-container">
        <a href="../index.html" class="nav-brand">Kos Atma</a>

        <button class="nav-toggle" id="navToggle">â˜°</button>

        <ul class="nav-menu" id="navMenu">
          <li><a href="../index.html">Beranda</a></li>
          <li><a href="../pages/cari-kos.html">Cabang Kami</a></li>

          <!-- Menu untuk user yang belum login -->
          <li class="guest-menu">
            <a href="../auth/login.html" class="btn btn-outline">Masuk</a>
          </li>
          <li class="guest-menu">
            <a href="../auth/register.html" class="btn btn-primary">Daftar</a>
          </li>

          <!-- Menu untuk user yang sudah login -->
          <li class="user-menu" style="display: none">
            <div class="nav-dropdown">
              <a href="#" class="dropdown-toggle">
                <img
                  src="../assets/images/default-avatar.svg"
                  alt="Profile"
                  class="nav-profile-img"
                  id="navProfileImg"
                />
                <span id="navUserName">User</span>
              </a>
              <ul class="dropdown-menu">
                <li><a href="profile.html">Profil Saya</a></li>
                <li><a href="my-bookings.html">Booking Saya</a></li>
                <li>
                  <a href="chat.html" class="inbox-link active"
                    >Inbox
                    <span
                      id="inboxBadge"
                      class="inbox-badge"
                      style="display: none"
                      >0</span
                    ></a
                  >
                </li>
                <li class="admin-link" style="display: none">
                  <a href="../admin/dashboard.html">Admin Panel</a>
                </li>
                <li><hr /></li>
                <li><a href="#" id="logoutBtn">Keluar</a></li>
              </ul>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <main class="chat-page">
      <div class="chat-container">
        <div class="chat-card">
          <div class="chat-card-header">
            <h1>Inbox</h1>
          </div>

          <div class="chat-messages-container" id="chatMessages">
            <div class="chat-empty">
              <div class="chat-empty-icon">ðŸ’¬</div>
              <p>Belum ada pesan</p>
            </div>
          </div>

          <div class="chat-input-container">
            <form class="chat-form" id="chatForm">
              <input
                type="text"
                id="chatInput"
                placeholder="Ketik pesan Anda..."
                maxlength="500"
                autocomplete="off"
              />
              <button type="submit" class="btn btn-primary" id="sendBtn">
                Kirim
              </button>
            </form>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-bottom">
        <p>&copy; 2025 Kos Atma. All rights reserved.</p>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
      let refreshInterval = null;

      document.addEventListener("DOMContentLoaded", async function () {
        // Cek autentikasi
        const user = await requireAuth();
        if (!user) return;

        // Update navbar
        document.querySelectorAll(".guest-menu").forEach((el) => {
          el.classList.remove("show");
          el.style.display = "none";
        });
        document.querySelectorAll(".user-menu").forEach((el) => {
          el.classList.add("show");
          el.style.display = "block";
        });

        const firstName = user.nama.split(" ")[0];
        document.getElementById("navUserName").textContent = firstName;
        const navProfileImg = document.getElementById("navProfileImg");
        if (user.foto) {
          navProfileImg.src = UPLOAD_BASE_URL + "/profiles/" + user.foto;
        }
        navProfileImg.onerror = function () {
          this.src = "../assets/images/default-avatar.svg";
        };

        if (user.role === "admin") {
          document.querySelectorAll(".admin-link").forEach((el) => {
            el.classList.add("show");
            el.style.display = "block";
          });
        }

        // Logout handler
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });

        // Mobile nav toggle
        const navToggle = document.getElementById("navToggle");
        const navMenu = document.getElementById("navMenu");
        if (navToggle && navMenu) {
          navToggle.addEventListener("click", function () {
            navMenu.classList.toggle("active");
          });
        }

        // Mark as read immediately when opening inbox
        await markAsRead();

        // Hide badge immediately
        const badge = document.getElementById("inboxBadge");
        if (badge) badge.style.display = "none";

        // Load messages
        await loadMessages();

        // Auto refresh every 5 seconds
        refreshInterval = setInterval(loadMessages, 5000);

        // Handle form submit
        document
          .getElementById("chatForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await sendMessage();
          });
      });

      async function loadMessages() {
        try {
          const response = await fetch(
            API_BASE_URL + "/api/chat/messages.php",
            {
              credentials: "include",
            }
          );
          const result = await response.json();

          if (result.success && result.data) {
            renderMessages(result.data);
            // Mark messages as read after loading
            await markAsRead();
            // Update badge to 0
            const badge = document.getElementById("inboxBadge");
            if (badge) badge.style.display = "none";
          }
        } catch (error) {
          console.error("Error loading messages:", error);
        }
      }

      function renderMessages(messages) {
        const container = document.getElementById("chatMessages");

        if (messages.length === 0) {
          container.innerHTML = `
                    <div class="chat-empty">
                        <div class="chat-empty-icon">ðŸ’¬</div>
                        <p>Belum ada pesan</p>
                    </div>
                `;
          return;
        }

        let html = '<div class="message-wrapper">';
        let lastDate = "";

        messages.forEach((msg) => {
          const msgDate = new Date(msg.created_at).toLocaleDateString("id-ID", {
            day: "numeric",
            month: "long",
            year: "numeric",
          });

          if (msgDate !== lastDate) {
            html += `<div class="chat-date-divider"><span>${msgDate}</span></div>`;
            lastDate = msgDate;
          }

          const isAdmin = msg.sender_type === "admin";
          const time = new Date(msg.created_at).toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
          });

          html += `
                    <div class="message ${isAdmin ? "received" : "sent"}">
                        <div class="message-text">${escapeHtml(
                          msg.message
                        )}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
        });

        html += "</div>";
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
      }

      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (!message) return;

        const sendBtn = document.getElementById("sendBtn");
        sendBtn.disabled = true;
        sendBtn.textContent = "Mengirim...";

        try {
          const response = await fetch(API_BASE_URL + "/api/chat/send.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({ message }),
          });
          const result = await response.json();

          if (result.success) {
            input.value = "";
            await loadMessages();
          } else {
            alert(result.message || "Gagal mengirim pesan");
          }
        } catch (error) {
          console.error("Error sending message:", error);
          alert("Gagal mengirim pesan");
        }

        sendBtn.disabled = false;
        sendBtn.textContent = "Kirim";
        input.focus();
      }

      async function markAsRead() {
        try {
          console.log(
            "Calling markAsRead to:",
            API_BASE_URL + "/api/chat/read.php"
          );
          const response = await fetch(API_BASE_URL + "/api/chat/read.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({}),
          });
          console.log("Response status:", response.status);
          const result = await response.json();
          console.log("Mark as read result:", result);
        } catch (error) {
          console.error("Error marking as read:", error);
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
